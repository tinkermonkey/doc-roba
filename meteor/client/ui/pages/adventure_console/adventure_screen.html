<template name="AdventureScreen">
  <div class="live-adventure-view">
    {{#if state.get.url}}
      <div class="live-adventure-header">
        {{#with state.get}}
          <h4>{{title}}</h4>
          <div>{{url}}</div>
          <div>
            <small>viewport is {{viewportSize.width}}px x {{viewportSize.height}}px,</small>
            <small>scrolled to ({{scroll.x}}, {{scroll.y}})</small>
            <small>Mouse at ({{mouse.x}}, {{mouse.y}})</small>
          </div>
        {{/with}}
      </div>
    {{/if}}
    
    {{#if state.get.screenshot}}
      {{updateViewport}}
      <img class="remote-screen" src="data:image/png;base64,{{state.get.screenshot}}">
      <div class="remote-screen-mask"
           style="{{#with getScreenMaskPosition}}top: {{top}}px; left: {{left}}px; height: {{height}}px; width: {{width}}px;{{/with}}">
        {{#with getMousePosition}}
          <div class="remote-screen-pointer" style="top: {{y}}px; left: {{x}}px;">
            <span class="glyphicon glyphicon-screenshot"></span>
          </div>
        {{/with}}
        
        <div class="adventure-hover-element-highlight" style="visibility: hidden;"></div>
        
        {{> AdventureHoverControls }}
        
        {{#each highlightElements.get}}
          {{#with processHighlightElement}}
            {{> AdventureHighlightElement }}
          {{/with}}
        {{/each}}
        
        {{#each previewElements.get}}
          {{#each getPreviewMatches}}
            {{#with processHighlightElement}}
              {{> AdventurePreviewElement }}
            {{/with}}
          {{/each}}
        {{/each}}
      </div>
      
      <div class="live-adventure-toolbar">
        {{> AdventureToolbar }}
      </div>
      {{#if getCheckResult}}
        {{#with getCheckResult}}
          <div class="well">
            {{> AdventureSelectorResult currentNodeId=../currentNodeId.get adventure=../adventure.get}}
            {{#each selectors}}
              {{> AdventureSelectorResult selector=this currentNodeId=../../currentNodeId.get adventure=../../adventure.get}}
            {{/each}}
          </div>
        {{/with}}
      {{/if}}
    {{else}}
      <div class="remote-screen remote-screen-loading">
        <div class="remote-screen-loading-log">
          {{> AdventureLogEmbedded }}
        </div>
        {{#unless adventureIsStill }}
          {{> RobaSpinner }}
        {{/unless}}
      </div>
    {{/if}}
    
    
    {{#each highlightElements.get}}
      {{#with processHighlightElement}}
        {{> AdventureHighlightDetail }}
      {{/with}}
    {{/each}}
    
    {{#each previewElements.get}}
      {{#each getPreviewMatches}}
        {{#with processHighlightElement}}
          {{> AdventurePreviewDetail }}
        {{/with}}
      {{/each}}
    {{/each}}
    
    <div class="adventure-highlight-list">
      {{#if highlightElements.get}}
        <div class="">
          <table class="table table-striped">
            <caption>Matched Elements</caption>
            <tbody>
            {{#each highlightElements.get}}
              <tr>
                <td>{{@index}}</td>
                <td>
                  <span class="glyphicon glyphicon-chevron-down pull-right detail-toggle"></span>
                  <div class="adventure-highlight-list-row-header">
                    &lt;<span class="clickable tag">{{tag}}</span>
                    {{#each attributes}}
                      <span class="attr">{{name}}</span>="{{#each splitValues ..}}<span
                      class="clickable value">{{value}}</span>{{#unless last}} {{/unless}}{{/each}}"
                    {{/each}}&gt;
                  </div>
                  
                  <div class="adventure-highlight-list-row-detail">
                    <div class="">
                      <h4>Selectors</h4>
                      {{#each selectors}}
                        {{> AdventureSelectorResult selector=this currentNodeId=../../currentNodeId.get adventure=../../adventure.get }}
                      {{/each}}
                      <h4>Text</h4>
                      <div>{{text}}</div>
                      <h4>HTML</h4>
                      <div>{{html}}</div>
                    </div>
                  </div>
                </td>
              </tr>
            {{/each}}
            </tbody>
          </table>
        </div>
      {{/if}}
    </div>
  </div>
</template>